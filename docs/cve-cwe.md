## CVE Vulnerability -> CWE Weakness Relationship (`cve-cwe`)

* Source collection: `nvd_cve_vertex_collection` (`type==vulnerability` objects only)
* Destination collections: `mitre_cwe_vertex_collection` (`type==weakness` objects only)

CWE's are referenced inside the `external_references.external_id` of a CVE vulnerability (`vulnerability`). e.g.

```json
    "external_references": [
        {
            "source_name": "cve",
            "url": "https://nvd.nist.gov/vuln/detail/CVE-2019-6535",
            "external_id": "CVE-2019-6535"
        },
        {
            "source_name": "cwe",
            "url": "https://cwe.mitre.org/data/definitions/CWE-400.html",
            "external_id": "CWE-400"
        },
        {
            "source_name": "cwe",
            "url": "https://cwe.mitre.org/data/definitions/CWE-400.html",
            "external_id": "CWE-400"
        },
        {
            "source_name": "ics-cert@hq.dhs.gov",
            "description": "Third Party Advisory,VDB Entry",
            "url": "http://www.securityfocus.com/bid/106771"
        },
```

You can find a list of all CWE Objects referenced in CVE objects using the following search;

```sql
FOR doc IN nvd_cve_vertex_collection
    FILTER doc._stix2arango_note != "automatically imported on collection creation"
    AND doc.type == "vulnerability"
    LET cweReferences = (
        FOR reference IN (IS_ARRAY(doc.external_references) ? doc.external_references : [])
            FILTER reference.source_name == 'cwe'
            AND reference.external_id == 'NVD-CWE-noinfo'
            RETURN reference.external_id
    )
    FILTER LENGTH(cweReferences) > 0
    FOR cweId IN cweReferences
    COLLECT id = cweId WITH COUNT INTO count
    RETURN { id, count }
```

CWE STIX IDs can be searched as follows;

```sql
LET ids = ["CWEID"]

FOR doc IN mitre_cwe_vertex_collection
    FILTER LENGTH(doc.external_references) > 0
    FOR ref IN doc.external_references
        FILTER ref.external_id IN ids
        COLLECT id = ref.external_id WITH COUNT INTO count
        RETURN { id, count }
```

When a CWE is referenced in a CVE Vulnerability object a Relationship Object joins them with the following structure.

```json
{
    "type": "relationship",
    "spec_version": "2.1",
    "id": "relationship--<UUIDV5 GENERATION LOGIC>",
    "created_by_ref": "<IMPORTED IDENTITY OBJECT>",
    "created": "<vulnerabilities.cve.published>",
    "modified": "<vulnerabilities.cve.lastModifiedDate>",
    "relationship_type": "exploited-using",
    "source_ref": "vulnerability--<CVE VULNERABILITY OBJECT>",
    "target_ref": "weakness--<CWE VULNERABILITY OBJECT>",
    "description": "<CVE name> <relationship_type without - char> <CWE name>",
    "object_marking_refs": [
        "marking-definition--94868c89-83c2-464b-929b-a1a8aa3c8487",
        "<MARKING DEFINITION IMPORTED>"
    ]
}
```

To generate the id of SRO, a UUIDv5 is generated using the namespace `2e51a631-99d8-52a5-95a6-8314d3f4fbf3` and the `relationship_type+source_collection_name/source_ref+target_collection_name/target_ref`  values.

All generated objects are stored in the source edge collection.

You should also use add the arango internal property `_arango_cti_processor_note` == `cve-cwe`