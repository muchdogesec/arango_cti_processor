## CVE Indicator -> CPE Software Relationship (`cve-cpe`)

* Source collection: `nvd_cve_vertex_collection` (`type==vulnerability` objects only)
* Destination collections: `nvd_cpe_vertex_collection` (`type==software` objects only)

The `pattern` property inside the Indicator SDO contains one or more CPE URIs. 

For example;

```json
"pattern": "([(software:cpe='cpe:2.3:o:tesla:model_3_firmware:*:*:*:*:*:*:*:*')]) OR ([(software:cpe='cpe:2.3:o:tesla:model_s_firmware:*:*:*:*:*:*:*:*')])"
```

You'll also see the CPEs in the pattern in the `x_cpes` property, e.g. 

```json
    "x_cpes": {
        "not_vulnerable": [
            {
                "criteria": "cpe:2.3:o:tesla:model_3_firmware:*:*:*:*:*:*:*:*",
                "matchCriteriaId": "86619D7A-ACB6-489C-9C29-37C6018E5B4B"
            }
        ],
        "vulnerable": [
            {
                "criteria": "cpe:2.3:o:tesla:model_s_firmware:*:*:*:*:*:*:*:*",
                "matchCriteriaId": "FD68704D-C711-491F-B278-B02C6866738C"
            }
        ]
    }
```

These define what CPEs a are vulnerable in the pattern.

Not a CPE `criteria` might have more than one CPE linked to it.

You can identify this using the CPE Match Criteria API from the NVD. You need to set an `NVD_API_KEY` in the `.env` file for this to work in a stable way;

```shell
GET https://services.nvd.nist.gov/rest/json/cpematch/2.0?matchCriteriaId=86619D7A-ACB6-489C-9C29-37C6018E5B4B
```

Returns;

```
{
    "resultsPerPage": 1,
    "startIndex": 0,
    "totalResults": 1,
    "format": "NVD_CPEMatchString",
    "version": "2.0",
    "timestamp": "2024-08-20T14:49:15.137",
    "matchStrings": [
        {
            "matchString": {
                "matchCriteriaId": "86619D7A-ACB6-489C-9C29-37C6018E5B4B",
                "criteria": "cpe:2.3:o:tesla:model_3_firmware:*:*:*:*:*:*:*:*",
                "versionEndIncluding": "2022-03-26",
                "lastModified": "2022-10-05T14:00:34.840",
                "cpeLastModified": "2022-10-05T14:00:34.840",
                "created": "2022-04-04T12:37:32.813",
                "status": "Active",
                "matches": [
                    {
                        "cpeName": "cpe:2.3:o:tesla:model_3_firmware:-:*:*:*:*:*:*:*",
                        "cpeNameId": "979F9EB6-C9F6-49EE-9FED-2ED17E400E86"
                    },
                    {
                        "cpeName": "cpe:2.3:o:tesla:model_3_firmware:11.0:*:*:*:*:*:*:*",
                        "cpeNameId": "62DCA7AD-A796-486F-8FB6-DEACC078D402"
                    },
                    {
                        "cpeName": "cpe:2.3:o:tesla:model_3_firmware:2022-03-26:*:*:*:*:*:*:*",
                        "cpeNameId": "F010C8B7-83E9-45FB-A5D4-26EDF34EC312"
                    }
                ]
            }
        }
    ]
}
```

You can use the `cpeNameId` to match it to a software object using the `software.swid` property.

This needs to be done for all `matchCriteriaId`s shown.

The corresponding STIX objects for the `swid` returned by the `matchCriteriaId`s can be identified as follows;

```sql
FOR doc IN nvd_cpe_vertex_collection
    FILTER doc.swid == "<VALUE>"
    RETURN doc
```

e.g.

```sql
FOR doc IN nvd_cpe_vertex_collection
    FILTER doc.swid == "979F9EB6-C9F6-49EE-9FED-2ED17E400E86"
    RETURN doc
```

### For all CPEs (vulnerable and not vulnerable)

A relationship between the Indicator and corresponding Software object is made and represented as follows;

```json
{
    "type": "relationship",
    "spec_version": "2.1",
    "id": "relationship--<UUID V5 LOGIC>",
    "created_by_ref": "<IMPORTED IDENTITY OBJECT>",
    "created": "<vulnerabilities.cve.published>",
    "modified": "<vulnerabilities.cve.lastModifiedDate>",
    "relationship_type": "pattern-contains",
    "source_ref": "indicator--<INDICATOR STIX OBJECT>",
    "target_ref": "software--<SOFTWARE STIX OBJECT>",
    "description": "<Indicator name> <relationship_type without - char> <CPE ID>",
    "object_marking_refs": [
        "marking-definition--94868c89-83c2-464b-929b-a1a8aa3c8487",
        "<MARKING DEFINITION IMPORTED>"
    ]
}
```

To generate the id of SRO, a UUIDv5 is generated using the namespace `2e51a631-99d8-52a5-95a6-8314d3f4fbf3` and the `relationship_type+source_collection_name/source_ref+target_collection_name/target_ref`  values.

All generated objects are stored in the source edge collection.

You should also use add the arango internal property `_arango_cti_processor_note` == `cve-cpe`

### For vulnerable CPEs only

A relationship between the Indicator and corresponding Software object is made and represented as follows;

```json
{
    "type": "relationship",
    "spec_version": "2.1",
    "id": "relationship--<UUID V5 LOGIC>",
    "created_by_ref": "<IMPORTED IDENTITY OBJECT>",
    "created": "<vulnerabilities.cve.published>",
    "modified": "<vulnerabilities.cve.lastModifiedDate>",
    "relationship_type": "is-vulnerable",
    "source_ref": "indicator--<INDICATOR STIX OBJECT>",
    "target_ref": "software--<SOFTWARE STIX OBJECT>",
    "description": "<Indicator name> <relationship_type without - char> <CPE ID>",
    "object_marking_refs": [
        "marking-definition--94868c89-83c2-464b-929b-a1a8aa3c8487",
        "<MARKING DEFINITION IMPORTED>"
    ]
}
```

To generate the id of SRO, a UUIDv5 is generated using the namespace `2e51a631-99d8-52a5-95a6-8314d3f4fbf3` and the `relationship_type+source_collection_name/source_ref+target_collection_name/target_ref`  values.

You should also use add the arango internal property `_arango_cti_processor_note` == `cve-cpe`